# RISKCORE CI Pipeline
# Runs on push/PR to develop and master branches

name: CI

on:
  push:
    branches: [develop, master]
  pull_request:
    branches: [develop, master]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ============================================
  # JOB 1: Validate repository structure
  # ============================================
  validate:
    name: Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          echo "Checking repository structure..."
          
          # Required files
          FILES=(
            "README.md"
            "CLAUDE.md"
          )
          
          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "✓ $file exists"
            else
              echo "✗ $file missing"
              exit 1
            fi
          done
          
          # Required directories
          DIRS=(
            "docs"
            "supabase/migrations"
          )
          
          for dir in "${DIRS[@]}"; do
            if [ -d "$dir" ]; then
              echo "✓ $dir/ exists"
            else
              echo "✗ $dir/ missing"
              exit 1
            fi
          done
          
          echo ""
          echo "All required files and directories present!"

      - name: Validate SQL migrations
        run: |
          echo "Checking SQL migration files..."
          
          MIGRATION_COUNT=$(find supabase/migrations -name "*.sql" 2>/dev/null | wc -l)
          
          if [ "$MIGRATION_COUNT" -gt 0 ]; then
            echo "Found $MIGRATION_COUNT migration file(s)"
            
            # Basic SQL syntax check (look for common issues)
            for file in supabase/migrations/*.sql; do
              if [ -f "$file" ]; then
                # Check for unclosed parentheses (basic check)
                OPEN=$(grep -o "(" "$file" | wc -l)
                CLOSE=$(grep -o ")" "$file" | wc -l)
                
                if [ "$OPEN" -ne "$CLOSE" ]; then
                  echo "⚠ Warning: Parentheses mismatch in $file (open: $OPEN, close: $CLOSE)"
                fi
                
                echo "✓ $file validated"
              fi
            done
          else
            echo "No migration files found (this is OK for initial setup)"
          fi

  # ============================================
  # JOB 2: Lint Python code
  # ============================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Python files
        id: check_python
        run: |
          if find . -name "*.py" -type f | grep -q .; then
            echo "has_python=true" >> $GITHUB_OUTPUT
            echo "Python files found"
          else
            echo "has_python=false" >> $GITHUB_OUTPUT
            echo "No Python files found - skipping lint"
          fi

      - name: Set up Python
        if: steps.check_python.outputs.has_python == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linters
        if: steps.check_python.outputs.has_python == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install ruff black

      - name: Run Ruff (linter)
        if: steps.check_python.outputs.has_python == 'true'
        run: ruff check . --output-format=github
        continue-on-error: true

      - name: Run Black (formatter check)
        if: steps.check_python.outputs.has_python == 'true'
        run: black --check --diff .
        continue-on-error: true

  # ============================================
  # JOB 3: Run tests
  # ============================================
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: validate
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: riskcore_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for test files
        id: check_tests
        run: |
          if find . -path "*/tests/*.py" -type f | grep -q .; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
            echo "Test files found"
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
            echo "No test files found - skipping tests"
          fi

      - name: Set up Python
        if: steps.check_tests.outputs.has_tests == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        if: steps.check_tests.outputs.has_tests == 'true'
        run: |
          python -m pip install --upgrade pip
          if [ -f backend/requirements.txt ]; then
            pip install -r backend/requirements.txt
          fi
          pip install pytest pytest-cov pytest-asyncio

      - name: Run tests
        if: steps.check_tests.outputs.has_tests == 'true'
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/riskcore_test
        run: |
          pytest backend/tests/ -v --tb=short
